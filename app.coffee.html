<!DOCTYPE html><html lang="en"><head><title>app.coffee</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="app.coffee"><meta name="groc-project-path" content="app.coffee.md"><meta name="groc-github-url" content="https://github.com/scanton/flaming-expresso"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/scanton/flaming-expresso/blob/master/app.coffee.md">app.coffee.md</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="appcoffeemdlitcoffeelogohttpsrawgithubcomscantonflamingexpressomasterpublicimageslitcoffeeiconpng">app.coffee.md <img src="https://raw.github.com/scanton/flaming-expresso/master/public/images/litCoffee-icon.png" alt="litCoffee Logo" title="" /></h1>

<h2 id="mainbootstrapserver">main (bootstrap) <strong>SERVER</strong></h2>

<p>This is the <em>main</em> application bootstrapping file that sets
up the web server and defines routes.</p>

<h4 id="include-external-packages">Include external packages</h4>

<p>external package requirements are defined in package.json
in this same root directory</p>

<h2 id="http">HTTP</h2>

<p>Http provides http protocol api</p>

<pre><code>http = require 'http'
</code></pre>

<h2 id="express-web-server">Express (web server)</h2>

<p><a href="http://expressjs.com/">Express</a> is our web server</p>

<pre><code>express = require 'express'
</code></pre>

<h2 id="file-system">File System</h2>

<p>We're going to need file system access to write server logs</p>

<pre><code>fs = require 'fs'
</code></pre>

<h2 id="path">Path</h2>

<p>This library helps us work with file system paths</p>

<pre><code>path = require 'path'
</code></pre>

<h1 id="app">app</h1>

<p><strong>app</strong> is our reference to the webserver</p>

<pre><code>app = express()
</code></pre>

<h2 id="config">Config</h2>

<p>This will allow us to store basic configuration details, like
database connections, or WSDLs based on the specific environment
(e.g. 'development', 'production', 'staging', etc.)</p>

<pre><code>config = require('./config.json')[app.get('env')]
</code></pre>

<h2 id="portset">Port(set)</h2>

<p>If no environment variable <em>PORT</em> is defined, then we listen
to port 3000 by default.</p>

<pre><code>app.set 'port', process.env.PORT || 3000
</code></pre>

<h2 id="views">Views</h2>

<p>The app will look for views in a folder called <em>/views</em></p>

<pre><code>app.set 'views', __dirname + '/views'
</code></pre>

<h2 id="jade">Jade</h2>

<p>Register Jade as the view engine. </p>

<p><a href="http://jade-lang.com/">Jade</a> is the HTML templating engine used in
this application.</p>

<pre><code>app.set 'view engine', 'jade'
</code></pre>

<h2 id="web-basics">Web Basics</h2>

<p>Instruct the app to use some basic webserver functionality</p>

<pre><code>app.use express.favicon(__dirname + '/public/favicon.ico')
app.use express.responseTime()
app.use express.bodyParser()
app.use express.methodOverride()
</code></pre>

<h2 id="logging">Logging</h2>

<p>We use Express' logger to write server logs to a file 'app.log' in
the root directory of this application.</p>

<pre><code>app.use express.logger
    format: ':date :remote-addr :method :url :status'
    stream: fs.createWriteStream 'app.log', 'flags': 'w'
</code></pre>

<h2 id="cookies">cookies</h2>

<pre><code>app.use express.cookieParser 'cookie secret here'
</code></pre>

<h2 id="session">session</h2>

<pre><code>app.use express.session()
</code></pre>

<h2 id="router">Router</h2>

<p>We want to use the app.router middleware before using
express.errorHandler middleware below.</p>

<pre><code>app.use app.router
</code></pre>

<h2 id="stylus">Stylus</h2>

<p>Register Stylus as the style middleware</p>

<p><a href="http://learnboost.github.io/stylus/">Stylus</a> is the CSS style language
used in this application.</p>

<pre><code>app.use require('stylus').middleware __dirname + '/public'
</code></pre>

<h2 id="static-public-directory">Static 'public' directory</h2>

<p>We're going to expose files that need to be served to the browser
(e.g. images, styleseets and javascripts) in a public folder</p>

<p>This prevents our application code (server-side litCoffee) from being
viewable from the web.</p>

<pre><code>app.use express.static path.join __dirname, 'public'
</code></pre>

<h2 id="error-handling">Error Handling</h2>

<p>If we are in the development environment, then we enable error handling</p>

<pre><code>if 'development' == app.get('env')
    app.use express.errorHandler()
</code></pre>

<h2 id="portget">Port(get)</h2>

<p>Get the port number the application will be listening to (this was set in
<a href="#portset">Port(set)</a> above)</p>

<pre><code>port = app.get 'port'
</code></pre>

<h2 id="respond-to-all-requests-no-404">Respond to all requests (no 404)</h2>

<p>This is where we declare routes for our router to use.  In our case,
we're going to handle application routing seperately from the main router.</p>

<pre><code>#app.get '/', (req, res) -&gt;
#   res.render 'index',
#       title: config.title
#       tagline: config.tagline
</code></pre>

<h4 id="custom-routing">Custom Routing</h4>

<p>After declaring our normal Routs (which we have none), using the express
Router, we handle all 404s (any request that hasn't already resolved to
a static file or otherwised caused the server to respond, such as an error).</p>

<pre><code>app.use (req, res, next) -&gt;
    RouteUtils = require __dirname + '/src/RouteUtils'
    RegExLibrary = require __dirname + '/src/RegExLibrary'
    ProxyServiceAdapter = require __dirname + '/src/ProxyServiceAdapter'
    ru = new RouteUtils(req, RegExLibrary, ProxyServiceAdapter)

    res.render 'index',
        title: config.title
        tagline: config.tagline
</code></pre>

<h1 id="createserver">CreateServer</h1>

<p>Construct the http server by passing a reference to the app then
register for listen events on that port.</p>

<pre><code>server = http.createServer(app).listen port, -&gt;
    console.log "Express server listening on port #{port}"
</code></pre>

<h1 id="web-sockets-socketio">Web Sockets (socket.io)</h1>

<p>We're going to use socket.io as our socket server.  We pass a
reference to our existing 'server', meaning socket.io will be able
to respond to socket oriented HTTP requests on the same port as the
web server.</p>

<pre><code>io = require('socket.io').listen server
</code></pre>

<h3 id="socket-events">Socket events</h3>

<p>We then register to listen for the <em>connection</em> event and define our
event handlers for an individual socket</p>

<pre><code>io.sockets.on 'connection', (socket) -&gt;
    soc = socket
    d = new Date();
    soc.emit 'onConnect', 
        message: "Connected to #{config.title}"
        date: d.toString()
        time: d.getTime()
    soc.on 'onConnect', (data) -&gt;
        console.log data
    soc.on 'onChat', (data) -&gt;
        data.username = soc.username
        io.sockets.emit 'updateChat', data
    soc.on 'setName', (data) -&gt;
        socket.username = data.message
        io.sockets.emit 'newUser', data
</code></pre></div></div></div></div></body></html>