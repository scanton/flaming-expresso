<!DOCTYPE html><html lang="en"><head><title>client/app-client.coffee</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="client/app-client.coffee"><meta name="groc-project-path" content="client/app-client.coffee.md"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">client/app-client.coffee.md</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="appclientlitcoffeelogohttpsrawgithubcomscantonflamingexpressomasterpublicimageslitcoffeeiconpng">app-client <img src="https://raw.github.com/scanton/flaming-expresso/master/public/images/litCoffee-icon.png" alt="litCoffee Logo" title="" /></h1>

<h2 id="mainbootstrapclient">main (bootstrap) <strong>CLIENT</strong></h2>

<p>This is the main application bootstraping on the client side.</p>

<h2 id="socket">socket</h2>

<p>We start by defining our web socket connection <em>socket</em>.  This URL should
be edited to match the location/port of your FlamingExpresso server.</p>

<pre><code>socket = io.connect 'http://localhost:3000'
</code></pre>

<h2 id="helper-functions">helper functions</h2>

<p>These are a few utility functons that are used later in this file:</p>

<h4 id="wrapmessage">wrapMessage</h4>

<p>This is just a hookpoint to intercept a message before it gets sent to the
server.  If we wanted to send other data (like a timestamp or game data), we could
add that information into this generic object created in <em>wrapMessage</em></p>

<pre><code>wrapMessage = (str) -&gt;
    return {message: str}
</code></pre>

<h4 id="htmlencode">htmlEncode</h4>

<p>This is a quick trick to use jQuery built in HTML encoding to sanitize a string.</p>

<pre><code>htmlEncode = (value) -&gt;
    return $('&lt;div/&gt;').text(value).html()
</code></pre>

<h4 id="htmldecode">htmlDecode</h4>

<p>This is the same trick like <em>htmlEncode</em> above.  We are using jQuery to htmlDecode
a string that is HTML encoded.</p>

<pre><code>htmlDecode = (value) -&gt;
    return $('&lt;div/&gt;').html(value).text()
</code></pre>

<h1 id="web-socket-events">Web Socket events</h1>

<h2 id="onconnect">onConnect</h2>

<p>onConnect is triggered when the cliet successfully connects to the FlamingExpresso
server.  All we are doing is outputting the data sent to the onConnect event to
the console.  We then append the chat history showing the user that they have connected
to a chat session.</p>

<pre><code>socket.on 'onConnect', (data) -&gt;
    console.log data
    $("#chat-history").append "&lt;p class='on-connect'&gt;&lt;span class='message'&gt; #{htmlEncode(data.message)}:&lt;/span&gt; #{data.date}&lt;/p&gt;"
    socket.emit 'onConnect', wrapMessage('client connected:')
</code></pre>

<h2 id="updatechat">updateChat</h2>

<p>updateChat is triggered when a user sends a new message to a chat session.  We determine
if the update came from the current user and then update the chatHistory div by appending
the new message to the view.  Finally, we scroll the chatHistory to the bottom of the page
showing the most recent messages at the bottom.</p>

<pre><code>socket.on 'updateChat', (data) -&gt;
    self = data.username == socket.username ? 'self' : ''
    $chatHistory = $ "#chat-history"
    $chatHistory.append "&lt;p class='chat'&gt;&lt;span class='username #{self}'&gt;#{htmlEncode(data.username)}&lt;/span&gt;: #{htmlEncode(data.message)}&lt;/p&gt;"
    $chatHistory.scrollTop $chatHistory[0].scrollHeight
</code></pre>

<h2 id="newuser">newUser</h2>

<p>newUser is triggered when a new user connects to a chat session.</p>

<p>We update the chatHistory to let everyone know that the new user has joined the
chat.  Also, if the newUser event came from the current client (e.g. 
socket.username == data.message), we update the webpage to remove the login login
form and display the chat views.</p>

<pre><code>socket.on 'newUser', (data) -&gt;
    $chatHistory = $ "#chat-history"
    $chatHistory.append "&lt;p class='new-user'&gt;&lt;span class='username'&gt;#{htmlEncode(data.message)}&lt;/span&gt; has joined the conversation.&lt;/p&gt;"
    $chatHistory.scrollTop $chatHistory[0].scrollHeight
    if socket.username == data.message
        $("#authenticate").hide 'slow'
        $("#chat").show 'slow'
        $("#chat-input").focus()
</code></pre>

<h1 id="jquery">jQuery</h1>

<p><em>$ -></em> is the jQuery <strong>$(document).ready()</strong> event handler.  When the document has
fully loaded (images and other assets may not have loaded yet, but the document has)
this code will be executed in the browser.</p>

<pre><code>$ -&gt;
</code></pre>

<p>Our current home page is fairly simple.  We make it even more simple my focusing
the cursor on the login-form inputs</p>

<pre><code>    $("#login-form input[name='username']").focus()
</code></pre>

<p>When the login form is submitted, we intercept that event (so the page does not
refresh), and then emit 'setName' into our <em>socket</em> to let other users know
our chat name.</p>

<p><em>note:</em> currently there is no authentication.  A user can set their name to anything
including names other users are currently using.  This will change later.</p>

<pre><code>    $("#login-form").submit (e) -&gt;
        e.preventDefault()
        name = $("#login-form input[name='username']").val()
        if name
            socket.username = name
            socket.emit 'setName', wrapMessage(name)
</code></pre>

<p>When the user submits the chat input form, we intercept the event to prevent page
refresh.  We then clean up the UI (removing the message from the chat input) and
emit the onChat event to the <em>socket</em> which sends the message to everyone listening,
including the client sending the message.</p>

<pre><code>    $("#chat-input-form").submit (e) -&gt;
        e.preventDefault()
        $chatInput = $ "#chat-input"
        message = $chatInput.val()
        $chatInput.val ''
        socket.emit 'onChat', wrapMessage(message)
</code></pre></div></div></div></div></body></html>